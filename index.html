<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>고입 내신성적 산출(200점)</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --line:#d9dde7; --line2:#c8cedd;
      --head:#eef2f9; --head2:#f4f6fb; --text:#222; --muted:#666;
      --accent:#1f5fbf; --accent2:#0c3d8a; --danger:#b42318;
      --soft:#f9fafc;
    }
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
    }
    .wrap{ max-width:1180px; margin:24px auto; padding:0 16px 60px; }
    .titlebar{
      background:linear-gradient(90deg,var(--accent2),var(--accent));
      color:#fff; border-radius:10px; padding:16px 18px; box-shadow:0 8px 18px rgba(0,0,0,.08);
    }
    .titlebar h1{ margin:0; font-size:18px; font-weight:700; }
    .titlebar p{ margin:6px 0 0; font-size:13px; opacity:.95; line-height:1.4; }
    .grid{ display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 1.2fr .8fr; } }

    .card{ background:var(--card); border:1px solid var(--line); border-radius:10px; overflow:hidden; }
    .card .hd{ background:var(--head); border-bottom:1px solid var(--line); padding:12px 14px; font-weight:700; }
    .card .bd{ padding:12px 14px; }

    .hint{ font-size:12px; color:var(--muted); line-height:1.5; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--line2); font-size:12px; color:var(--muted); background:var(--head2); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    table{ width:100%; border-collapse:collapse; margin-top:10px; table-layout:fixed; }
    th, td{ border:1px solid var(--line); padding:8px 8px; font-size:13px; }
    th{ background:var(--head); text-align:center; }
    td{ background:#fff; }
    td input, td select{ width:100%; box-sizing:border-box; padding:6px 8px; border-radius:6px; border:1px solid var(--line2); }
    td .badge{
      display:inline-block; width:100%; text-align:center;
      padding:3px 8px; border-radius:999px; border:1px solid var(--line2);
      background:var(--head2); font-weight:700;
    }

    .btnbar{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    button{
      cursor:pointer; padding:8px 10px; border-radius:8px; border:1px solid var(--line2);
      background:var(--head2); color:var(--text);
    }
    button.primary{ background:var(--accent); border-color:var(--accent); color:#fff; }
    button.danger{ background:#fff; border-color:rgba(180,35,24,.35); color:var(--danger); }
    button:hover{ filter:brightness(.98); }

    details{ border:1px solid var(--line); border-radius:10px; overflow:hidden; margin-top:12px; }
    summary{ cursor:pointer; list-style:none; padding:10px 12px; background:var(--head2); font-weight:700; }
    summary::-webkit-details-marker{ display:none; }
    details .inside{ padding:10px 12px; }

    .resultBox{
      border:1px solid var(--line2); border-radius:10px; padding:12px 12px; background:#fff;
      display:flex; align-items:baseline; justify-content:space-between; gap:10px;
    }
    .big{ font-size:22px; font-weight:800; }
    .kpiTable td{ text-align:right; }
    .kpiTable td:first-child{ text-align:left; }

    /* 비교과 UI */
    .ncGrid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:8px; }
    @media (min-width: 720px){ .ncGrid{ grid-template-columns: 1fr 1fr; } }
    .ncCard{
      border:1px solid var(--line);
      background:var(--soft);
      border-radius:12px;
      padding:12px;
    }
    .ncHead{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
    .ncTitle{ font-weight:800; }
    .scoreChip{
      display:inline-flex; align-items:baseline; gap:6px;
      padding:4px 10px; border-radius:999px;
      border:1px solid var(--line2);
      background:#fff;
      font-weight:800;
    }
    .scoreChip small{ font-weight:600; color:var(--muted); }
    .formRow{ display:grid; grid-template-columns: 1fr; gap:10px; }
    .formField label{ display:block; margin:0 0 6px; font-size:12px; color:var(--muted); }
    .formField input, .formField select{
      width:100%; box-sizing:border-box;
      padding:10px 10px; border-radius:10px;
      border:1px solid var(--line2);
      background:#fff;
      outline:none;
    }
    .formField input:focus, .formField select:focus{
      border-color: var(--accent);
      box-shadow:0 0 0 3px rgba(31,95,191,.14);
    }
    .helperLine{ margin-top:8px; font-size:12px; color:var(--muted); line-height:1.5; }
    .miniPill{
      display:inline-block; padding:2px 8px; border-radius:999px;
      border:1px solid var(--line2); background:#fff; color:var(--muted); font-size:12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="titlebar">
      <h1>고입 내신성적 산출(200점)</h1>
      <p>
        일반교과는 <b>원점수(0~100)</b>만 입력하면 성취도(A~E)가 자동 반영됩니다.
        <span class="pill">교과 150(일반120+체·예30)</span>
        <span class="pill">비교과 50(출결20+봉사20+학교활동10)</span>
      </p>
      <p>
        이 자료는 개인 점검용으로 실제와는 다를 수 있습니다. 자세한 사항은 경기도 고교입학전학포털 사이트를 참고해 주세요.
      </p>
    </div>

    <div class="grid">
      <!-- 입력 -->
      <div class="card">
        <div class="hd">입력</div>
        <div class="bd">

          <details>
            <summary>성취도 자동판정 기준(고정)</summary>
            <div class="inside">
              <div class="hint">
                원점수 → 성취도: <b>A≥90, B≥80, C≥70, D≥60, 그 외 E</b><br/>
                성취도 환산값: <b>A=5, B=4, C=3, D=2, E=1</b>
              </div>
            </div>
          </details>

          <details open>
            <summary>일반교과 (총 120점)</summary>
            <div class="inside">
              <div class="hint">
                학기점수 = 기본점수 + (성취도평균×계수) + (원점수평균×계수) / 학기별 만점 상한 적용<br/>
                빈 행은 계산에서 제외됩니다.
              </div>

              <!-- 1-2 -->
              <section style="margin-top:12px;">
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
                  <div><b>1학년 2학기</b> <span class="pill">최대 12점</span></div>
                  <div class="btnbar" style="margin:0;">
                    <button type="button" data-add="g12">과목 추가</button>
                    <button type="button" class="danger" data-clear="g12">전체 비우기</button>
                  </div>
                </div>
                <table>
                  <colgroup><col style="width:48%"><col style="width:22%"><col style="width:16%"><col style="width:14%"></colgroup>
                  <thead><tr><th>과목명</th><th>원점수</th><th>성취도</th><th>삭제</th></tr></thead>
                  <tbody id="tbody_g12"></tbody>
                </table>
                <div class="hint mono" id="summary_g12" style="margin-top:6px;"></div>
              </section>

              <!-- 2-1 -->
              <section style="margin-top:14px;">
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
                  <div><b>2학년 1학기</b> <span class="pill">최대 24점</span></div>
                  <div class="btnbar" style="margin:0;">
                    <button type="button" data-add="g21">과목 추가</button>
                    <button type="button" class="danger" data-clear="g21">전체 비우기</button>
                  </div>
                </div>
                <table>
                  <colgroup><col style="width:48%"><col style="width:22%"><col style="width:16%"><col style="width:14%"></colgroup>
                  <thead><tr><th>과목명</th><th>원점수</th><th>성취도</th><th>삭제</th></tr></thead>
                  <tbody id="tbody_g21"></tbody>
                </table>
                <div class="hint mono" id="summary_g21" style="margin-top:6px;"></div>
              </section>

              <!-- 2-2 -->
              <section style="margin-top:14px;">
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
                  <div><b>2학년 2학기</b> <span class="pill">최대 24점</span></div>
                  <div class="btnbar" style="margin:0;">
                    <button type="button" data-add="g22">과목 추가</button>
                    <button type="button" class="danger" data-clear="g22">전체 비우기</button>
                  </div>
                </div>
                <table>
                  <colgroup><col style="width:48%"><col style="width:22%"><col style="width:16%"><col style="width:14%"></colgroup>
                  <thead><tr><th>과목명</th><th>원점수</th><th>성취도</th><th>삭제</th></tr></thead>
                  <tbody id="tbody_g22"></tbody>
                </table>
                <div class="hint mono" id="summary_g22" style="margin-top:6px;"></div>
              </section>

              <!-- 3-1 -->
              <section style="margin-top:14px;">
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
                  <div><b>3학년 1학기</b> <span class="pill">최대 30점</span></div>
                  <div class="btnbar" style="margin:0;">
                    <button type="button" data-add="g31">과목 추가</button>
                    <button type="button" class="danger" data-clear="g31">전체 비우기</button>
                  </div>
                </div>
                <table>
                  <colgroup><col style="width:48%"><col style="width:22%"><col style="width:16%"><col style="width:14%"></colgroup>
                  <thead><tr><th>과목명</th><th>원점수</th><th>성취도</th><th>삭제</th></tr></thead>
                  <tbody id="tbody_g31"></tbody>
                </table>
                <div class="hint mono" id="summary_g31" style="margin-top:6px;"></div>
              </section>

              <!-- 3-2 -->
              <section style="margin-top:14px;">
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
                  <div><b>3학년 2학기</b> <span class="pill">최대 30점</span></div>
                  <div class="btnbar" style="margin:0;">
                    <button type="button" data-add="g32">과목 추가</button>
                    <button type="button" class="danger" data-clear="g32">전체 비우기</button>
                  </div>
                </div>
                <table>
                  <colgroup><col style="width:48%"><col style="width:22%"><col style="width:16%"><col style="width:14%"></colgroup>
                  <thead><tr><th>과목명</th><th>원점수</th><th>성취도</th><th>삭제</th></tr></thead>
                  <tbody id="tbody_g32"></tbody>
                </table>
                <div class="hint mono" id="summary_g32" style="margin-top:6px;"></div>
              </section>
            </div>
          </details>

          <details open>
            <summary>체육·예술교과 (총 30점)</summary>
            <div class="inside">
<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px; flex-wrap:wrap;">
  <div class="hint" style="flex:1; min-width:260px;">
    점수 = 10 + 20 × (3×a + 2×b + 1×c) / (3×N) (상한 30)<br/>
    <b>A/B/C로 선택된 과목만</b> 집계합니다(선택 안 하면 제외).
  </div>

  <div class="btnbar" style="margin:0; align-self:flex-start; justify-content:flex-end;">
    <button type="button" data-add="pe">과목 추가</button>
    <button type="button" class="danger" data-clear="pe">전체 비우기</button>
  </div>
</div>

              <table>
                <colgroup><col style="width:58%"><col style="width:22%"><col style="width:20%"></colgroup>
                <thead><tr><th>과목명</th><th>성취도(ABC)</th><th>삭제</th></tr></thead>
                <tbody id="tbody_pe"></tbody>
              </table>
              <div class="hint mono" id="summary_pe" style="margin-top:6px;"></div>
            </div>
          </details>

          <details open>
            <summary>비교과 (총 50점)</summary>
            <div class="inside">

              <div class="ncGrid">
                <!-- 출결 -->
                <div class="ncCard">
                  <div class="ncHead">
                    <div class="ncTitle">출결</div>
                    <div class="scoreChip"><span class="mono" id="sumAtt_chip">0.00</span> <small>/ 20</small></div>
                  </div>

                  <div class="formRow">
                    <div class="formField">
                      <label>1학년 결석일수</label>
                      <select id="att1">
                        <option value="" selected>선택</option>
                        <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="6+">6일 이상</option>
                      </select>
                    </div>
                    <div class="formField">
                      <label>2학년 결석일수</label>
                      <select id="att2">
                        <option value="" selected>선택</option>
                        <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="6+">6일 이상</option>
                      </select>
                    </div>
                    <div class="formField">
                      <label>3학년 결석일수</label>
                      <select id="att3">
                        <option value="" selected>선택</option>
                        <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option>
                        <option value="4">4</option><option value="5">5</option><option value="6+">6일 이상</option>
                      </select>
                    </div>
                  </div>

                  <div class="helperLine">
                    <span class="miniPill">1학년(6점)</span> 0=6,1=5.4,2=4.8,3=4.2,4=3.6,5=3.0,6+=2.4<br/>
                    <span class="miniPill">2·3학년(7점)</span> 0=7,1=6.3,2=5.6,3=4.9,4=4.2,5=3.5,6+=2.8
                  </div>
                </div>

                <!-- 봉사 -->
                <div class="ncCard">
                  <div class="ncHead">
                    <div class="ncTitle">봉사</div>
                    <div class="scoreChip"><span class="mono" id="sumVol_chip">0.00</span> <small>/ 20</small></div>
                  </div>

                  <div class="formRow">
                    <div class="formField">
                      <label>3개년 봉사시간(총합, 시간)</label>
                      <input id="vol_h" type="number" min="0" step="1" value="" placeholder="예: 12">
                    </div>
                  </div>

                  <div class="helperLine">
                    시간 입력 시 자동 점수화: 15시간 이상=20점, 14=19… 8=13, 7시간 이하=12점<br/>
                    <span class="miniPill">현재 봉사 점수</span> <b class="mono" id="vol_score_inline">0.00</b> / 20
                  </div>
                </div>

                <!-- 학교활동 -->
                <div class="ncCard">
                  <div class="ncHead">
                    <div class="ncTitle">학교활동</div>
                    <div class="scoreChip"><span class="mono" id="sumSch_chip">0.00</span> <small>/ 10</small></div>
                  </div>

                  <div class="formRow">
                    <div class="formField">
                      <label>수상실적(전체 학기 합계 개수)</label>
                      <input id="sch_awards" type="number" min="0" step="1" value="" placeholder="예: 3">
                    </div>
                    <div class="formField">
                      <label>자치회 임원활동 전체 개월수</label>
                      <input id="sch_months_total" type="number" min="0" step="1" value="" placeholder="예: 10">
                    </div>
                  </div>

                  <div class="helperLine">
                    <b>기본 8점</b> + 수상(개수×0.5) + 임원(개월수×0.1), 상한 10<br/>
                    <b>둘 다 미입력이어도 기본 8점</b> 적용
                  </div>
                </div>

                <!-- 비교과 합계 -->
                <div class="ncCard">
                  <div class="ncHead">
                    <div class="ncTitle">비교과 합계</div>
                    <div class="scoreChip"><span class="mono" id="sumNon_chip">0.00</span> <small>/ 50</small></div>
                  </div>
                  <div class="helperLine">
                    출결 + 봉사 + 학교활동 점수가 자동 합산됩니다.<br/>
                    <span class="miniPill">출결</span> <span class="mono" id="sumAtt_mini">0.00</span> /
                    <span class="miniPill">봉사</span> <span class="mono" id="sumVol_mini">0.00</span> /
                    <span class="miniPill">학교활동</span> <span class="mono" id="sumSch_mini">0.00</span>
                  </div>
                </div>
              </div>

            </div>
          </details>

          <div class="btnbar" style="margin-top:12px;">
            <button type="button" class="primary" id="btnAddAll">각 학기 5과목(빈행) 생성</button>
            <button type="button" class="danger" id="btnResetAll">전체 초기화</button>
          </div>
        </div>
      </div>

      <!-- 결과 -->
      <div class="card">
        <div class="hd">산출 결과</div>
        <div class="bd">
          <div class="resultBox">
            <div>
              <div class="hint">총점</div>
              <div class="big mono"><span id="total200">0.00</span> / 200</div>
            </div>
            <div class="pill" id="status">입력 대기</div>
          </div>

          <table class="kpiTable" style="margin-top:12px;">
            <thead><tr><th>구분</th><th>점수</th><th>만점</th></tr></thead>
            <tbody>
              <tr><td>일반교과 합</td><td class="mono" id="sumGeneral">0.00</td><td class="mono">120</td></tr>
              <tr><td>체육·예술교과</td><td class="mono" id="sumPE">0.00</td><td class="mono">30</td></tr>
              <tr><td><b>교과 합</b></td><td class="mono" id="sumSubject">0.00</td><td class="mono">150</td></tr>

              <tr><td>출결</td><td class="mono" id="sumAtt">0.00</td><td class="mono">20</td></tr>
              <tr><td>봉사</td><td class="mono" id="sumVol">0.00</td><td class="mono">20</td></tr>
              <tr><td>학교활동</td><td class="mono" id="sumSch">0.00</td><td class="mono">10</td></tr>
              <tr><td><b>비교과 합</b></td><td class="mono" id="sumNon">0.00</td><td class="mono">50</td></tr>

              <tr><td><b>총점</b></td><td class="mono" id="sumTotalRow">0.00</td><td class="mono">200</td></tr>
            </tbody>
          </table>

          <details style="margin-top:12px;">
            <summary>계산 로그</summary>
            <div class="inside">
              <pre id="log" class="mono" style="white-space:pre-wrap; margin:0; color:var(--muted);"></pre>
            </div>
          </details>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const CUTS = { A:90, B:80, C:70, D:60 };
  const MAP  = { A:5,  B:4,  C:3,  D:2,  E:1  };

  function num(v){ const x = parseFloat(v); return Number.isFinite(x) ? x : 0; }
  function int(v){ const x = parseInt(v,10); return Number.isFinite(x) ? x : 0; }
  function clamp(x, lo, hi){ return Math.min(hi, Math.max(lo, x)); }
  function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }

  function gradeFromRaw(rawStr){
    if(rawStr === "" || rawStr == null) return "";
    const r = num(rawStr);
    if(r >= CUTS.A) return "A";
    if(r >= CUTS.B) return "B";
    if(r >= CUTS.C) return "C";
    if(r >= CUTS.D) return "D";
    return "E";
  }

  function gradeSelectABC(value=""){
    return `
      <select class="grade">
        <option value="" ${value===""?"selected":""}>선택</option>
        <option value="A" ${value==="A"?"selected":""}>A</option>
        <option value="B" ${value==="B"?"selected":""}>B</option>
        <option value="C" ${value==="C"?"selected":""}>C</option>
      </select>
    `;
  }

  function makeRow(term){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="subj" type="text" value="" placeholder=""></td>
      <td><input class="raw" type="number" min="0" max="100" step="0.1" value="" placeholder=""></td>
      <td style="text-align:center;"><span class="badge gradeBadge">-</span></td>
      <td style="text-align:center;"><button type="button" class="danger btnDel">삭제</button></td>
    `;
    wireRow(tr);
    $("tbody_" + term).appendChild(tr);
  }

  function makeRowPE(){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="subj" type="text" value="" placeholder=""></td>
      <td>${gradeSelectABC("")}</td>
      <td style="text-align:center;"><button type="button" class="danger btnDel">삭제</button></td>
    `;
    wireRow(tr);
    $("tbody_pe").appendChild(tr);
  }

  function wireRow(tr){
    tr.querySelectorAll("input,select").forEach(el => {
      el.addEventListener("input", recalc);
      el.addEventListener("change", recalc);
    });
    tr.querySelector(".btnDel")?.addEventListener("click", () => { tr.remove(); recalc(); });
  }

  function clearTerm(term){
    const tb = $("tbody_" + term);
    while(tb.firstChild) tb.removeChild(tb.firstChild);
    recalc();
  }
  function clearPE(){
    const tb = $("tbody_pe");
    while(tb.firstChild) tb.removeChild(tb.firstChild);
    recalc();
  }

  function collectTerm(term){
    const rows = Array.from($("tbody_" + term).querySelectorAll("tr"));
    let n = 0, achSum = 0, rawSum = 0;

    for(const r of rows){
      const subj = (r.querySelector(".subj")?.value ?? "").trim();
      const rawStr = (r.querySelector(".raw")?.value ?? "").trim();

      const hasSomething = subj !== "" || rawStr !== "";
      if(!hasSomething){ r.querySelector(".gradeBadge").textContent = "-"; continue; }
      if(rawStr === ""){ r.querySelector(".gradeBadge").textContent = "-"; continue; }

      const g = gradeFromRaw(rawStr);
      r.querySelector(".gradeBadge").textContent = g || "-";

      n += 1;
      rawSum += num(rawStr);
      achSum += (MAP[g] ?? 0);
    }
    return { n, achSum, rawSum };
  }

  function termScore({n, achSum, rawSum, base, kAch, kRaw, max}){
    if(n <= 0) return { score: 0, detail: `원점수 입력 과목 없음 → 0점` };
    const s = base + (achSum / n) * kAch + (rawSum / n) * kRaw;
    const capped = clamp(s, 0, max);
    return { score: capped, detail: `${base} + (성취도평균 ${round2(achSum/n)})×${kAch} + (원점수평균 ${round2(rawSum/n)})×${kRaw} = ${round2(s)} → ${round2(capped)}` };
  }

  function collectPE(){
    const rows = Array.from($("tbody_pe").querySelectorAll("tr"));
    let N = 0, a = 0, b = 0, c = 0;

    for(const r of rows){
      const subj = (r.querySelector(".subj")?.value ?? "").trim();
      const g = (r.querySelector(".grade")?.value ?? "").trim();

      const hasSomething = subj !== "" || g !== "";
      if(!hasSomething) continue;
      if(g === "") continue;

      N += 1;
      if(g === "A") a += 1;
      else if(g === "B") b += 1;
      else if(g === "C") c += 1;
    }
    return {N,a,b,c};
  }

  function peScore({N,a,b,c}){
    if(N <= 0) return 0;
    const s = 10 + 20 * (3*a + 2*b + 1*c) / (3*N);
    return clamp(s, 0, 30);
  }

  function attendanceScore(year, abs){
    if(abs === "") return 0;
    const idx = (abs === "6+") ? 6 : int(abs);
    const map1 = [6, 5.4, 4.8, 4.2, 3.6, 3.0, 2.4];
    const map2 = [7, 6.3, 5.6, 4.9, 4.2, 3.5, 2.8];
    const map3 = [7, 6.3, 5.6, 4.9, 4.2, 3.5, 2.8];
    if(year === 1) return map1[idx] ?? 0;
    if(year === 2) return map2[idx] ?? 0;
    return map3[idx] ?? 0;
  }

  function volunteerScore(hoursStr){
    if(hoursStr === "") return 0;
    const h = int(hoursStr);
    if(h >= 15) return 20;
    if(h <= 7) return 12;
    return h + 5;
  }

  // ✅ 학교활동: 둘 다 미입력이어도 기본 8점
  function schoolActivityScore(awardsStr, monthsStr){
    const base = 8;
    const awards = 0.5 * int(awardsStr);
    const months = 0.1 * int(monthsStr);
    return clamp(base + awards + months, 0, 10);
  }

  function anyInputExists(){
    const terms = ["g12","g21","g22","g31","g32"];
    for(const t of terms){
      for(const r of Array.from($("tbody_"+t).querySelectorAll("tr"))){
        const subj = (r.querySelector(".subj")?.value ?? "").trim();
        const raw = (r.querySelector(".raw")?.value ?? "").trim();
        if(subj || raw) return true;
      }
    }
    for(const r of Array.from($("tbody_pe").querySelectorAll("tr"))){
      const subj = (r.querySelector(".subj")?.value ?? "").trim();
      const g = (r.querySelector(".grade")?.value ?? "").trim();
      if(subj || g) return true;
    }
    if($("att1").value || $("att2").value || $("att3").value) return true;
    if($("vol_h").value !== "") return true;
    if($("sch_awards").value !== "" || $("sch_months_total").value !== "") return true;
    return false;
  }

  function recalc(){
    const g12 = collectTerm("g12");
    const g21 = collectTerm("g21");
    const g22 = collectTerm("g22");
    const g31 = collectTerm("g31");
    const g32 = collectTerm("g32");

    const s12 = termScore({ ...g12, base:4,  kAch:0.8, kRaw:0.04, max:12 });
    const s21 = termScore({ ...g21, base:8,  kAch:1.6, kRaw:0.08, max:24 });
    const s22 = termScore({ ...g22, base:8,  kAch:1.6, kRaw:0.08, max:24 });
    const s31 = termScore({ ...g31, base:10, kAch:2.0, kRaw:0.10, max:30 });
    const s32 = termScore({ ...g32, base:10, kAch:2.0, kRaw:0.10, max:30 });

    const general = s12.score + s21.score + s22.score + s31.score + s32.score;
    const peAgg = collectPE();
    const pe = peScore(peAgg);
    const subject = general + pe;

    const att = attendanceScore(1,$("att1").value) + attendanceScore(2,$("att2").value) + attendanceScore(3,$("att3").value);
    const vol = volunteerScore($("vol_h").value);
    const sch = schoolActivityScore($("sch_awards").value, $("sch_months_total").value);
    const non = att + vol + sch;

    const total = subject + non;

    $("sumGeneral").textContent = round2(general).toFixed(2);
    $("sumPE").textContent = round2(pe).toFixed(2);
    $("sumSubject").textContent = round2(subject).toFixed(2);

    $("sumAtt").textContent = round2(att).toFixed(2);
    $("sumVol").textContent = round2(vol).toFixed(2);
    $("sumSch").textContent = round2(sch).toFixed(2);
    $("sumNon").textContent = round2(non).toFixed(2);

    $("sumAtt_chip").textContent = round2(att).toFixed(2);
    $("sumVol_chip").textContent = round2(vol).toFixed(2);
    $("sumSch_chip").textContent = round2(sch).toFixed(2);
    $("sumNon_chip").textContent = round2(non).toFixed(2);

    $("sumAtt_mini").textContent = round2(att).toFixed(2);
    $("sumVol_mini").textContent = round2(vol).toFixed(2);
    $("sumSch_mini").textContent = round2(sch).toFixed(2);

    $("total200").textContent = round2(total).toFixed(2);
    $("sumTotalRow").textContent = round2(total).toFixed(2);

    $("vol_score_inline").textContent = round2(vol).toFixed(2);

    $("summary_g12").textContent = `과목수=${g12.n}, 성취도합=${round2(g12.achSum)}, 원점수합=${round2(g12.rawSum)} → ${round2(s12.score).toFixed(2)}점`;
    $("summary_g21").textContent = `과목수=${g21.n}, 성취도합=${round2(g21.achSum)}, 원점수합=${round2(g21.rawSum)} → ${round2(s21.score).toFixed(2)}점`;
    $("summary_g22").textContent = `과목수=${g22.n}, 성취도합=${round2(g22.achSum)}, 원점수합=${round2(g22.rawSum)} → ${round2(s22.score).toFixed(2)}점`;
    $("summary_g31").textContent = `과목수=${g31.n}, 성취도합=${round2(g31.achSum)}, 원점수합=${round2(g31.rawSum)} → ${round2(s31.score).toFixed(2)}점`;
    $("summary_g32").textContent = `과목수=${g32.n}, 성취도합=${round2(g32.achSum)}, 원점수합=${round2(g32.rawSum)} → ${round2(s32.score).toFixed(2)}점`;

    $("summary_pe").textContent = `N=${peAgg.N}, a(A)=${peAgg.a}, b(B)=${peAgg.b}, c(C)=${peAgg.c} → ${round2(pe).toFixed(2)}점`;

    const lines = [
      `[일반교과]`,
      `- 1학년 2학기: ${s12.detail}`,
      `- 2학년 1학기: ${s21.detail}`,
      `- 2학년 2학기: ${s22.detail}`,
      `- 3학년 1학기: ${s31.detail}`,
      `- 3학년 2학기: ${s32.detail}`,
      ``,
      `[체육·예술]`,
      `- 10 + 20×(3a+2b+1c)/(3N) = ${round2(pe).toFixed(2)} (N=${peAgg.N}, a=${peAgg.a}, b=${peAgg.b}, c=${peAgg.c})`,
      ``,
      `[비교과]`,
      `- 출결: ${round2(att).toFixed(2)} / 20`,
      `- 봉사: ${round2(vol).toFixed(2)} / 20 (시간=${$("vol_h").value === "" ? "미입력" : $("vol_h").value})`,
      `- 학교활동: ${round2(sch).toFixed(2)} / 10`,
      ``,
      `[합계]`,
      `- 교과: ${round2(subject).toFixed(2)} / 150`,
      `- 비교과: ${round2(non).toFixed(2)} / 50`,
      `- 총점: ${round2(total).toFixed(2)} / 200`
    ];
    $("log").textContent = lines.join("\n");

    $("status").textContent = anyInputExists() ? "계산 완료" : "입력 대기";
  }

  document.addEventListener("click", (e) => {
    const add = e.target?.getAttribute?.("data-add");
    const clr = e.target?.getAttribute?.("data-clear");

    if(add){
      if(add === "pe") makeRowPE();
      else makeRow(add);
      recalc();
    }
    if(clr){
      if(clr === "pe") clearPE();
      else clearTerm(clr);
    }
  });

  $("btnAddAll").addEventListener("click", () => {
    const terms = ["g12","g21","g22","g31","g32"];
    for(const t of terms){
      if($("tbody_"+t).children.length === 0){
        for(let i=0;i<5;i++) makeRow(t);
      }
    }
    if($("tbody_pe").children.length === 0){
      for(let i=0;i<4;i++) makeRowPE();
    }
    recalc();
  });

  $("btnResetAll").addEventListener("click", () => {
    ["g12","g21","g22","g31","g32"].forEach(clearTerm);
    clearPE();
    $("att1").value = ""; $("att2").value = ""; $("att3").value = "";
    $("vol_h").value = "";
    $("sch_awards").value = "";
    $("sch_months_total").value = "";
    recalc();
  });

  ["att1","att2","att3","vol_h","sch_awards","sch_months_total"].forEach(id => {
    $(id).addEventListener("input", recalc);
    $(id).addEventListener("change", recalc);
  });

  recalc();
</script>
</body>
</html>
